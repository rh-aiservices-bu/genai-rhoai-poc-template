apiVersion: batch/v1
kind: Job
metadata:
  name: synchronize-model
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  backoffLimit: 8
  template:
    spec:
      containers:
        - name: s3-sync
          image: quay.io/jharmison/s3-sync:0.4.1
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
          args:
            - -c
            - |
              if "${S3_SYNC_LOCAL_UPLOAD_COMPLETE:-false}" >/dev/null 2>&1; then
                echo "Skipping sync as upload marked complete"
                exit 0
              fi
              s3-sync -vvvvv --no-dest-validate
          envFrom:
            - secretRef:
                name: demo-models
            - secretRef:
                name: model-source
      restartPolicy: Never
